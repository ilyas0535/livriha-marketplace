{% extends 'base.html' %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h4>Edit Product: {{ product.name }}</h4>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <div class="mb-3">
                            <label class="form-label">Product Name</label>
                            {{ form.name }}
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            {{ form.description }}
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Category</label>
                            {{ form.category }}
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Price ($)</label>
                                    {{ form.price }}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Old Price ($) - Optional</label>
                                    {{ form.old_price }}
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Quantity</label>
                                    {{ form.quantity }}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Low Stock Alert</label>
                                    {{ form.low_stock_threshold }}
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Add More Images</label>
                            {{ form.images }}
                            <div class="form-text">{{ form.images.help_text }}</div>
                        </div>
                        
                        <!-- Existing Variants -->
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5>Product Variants</h5>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="addVariant()">Add Variant</button>
                            </div>
                            
                            <!-- Existing variants -->
                            {% if product.variants.all %}
                                <div id="existing-variants">
                                    {% for variant in product.variants.all %}
                                    <div class="card mb-3" id="existing-variant-{{ variant.id }}">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <h6>{{ variant.name }}</h6>
                                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteVariant({{ variant.id }})">
                                                    Delete
                                                </button>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">Name</label>
                                                        <input type="text" class="form-control" name="existing_variant_name_{{ variant.id }}" value="{{ variant.name }}">
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">SKU</label>
                                                        <input type="text" class="form-control" name="existing_variant_sku_{{ variant.id }}" value="{{ variant.sku }}">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">Price Override</label>
                                                        <input type="number" step="0.01" class="form-control" name="existing_variant_price_{{ variant.id }}" value="{{ variant.price|default:'' }}">
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">Quantity</label>
                                                        <input type="number" class="form-control" name="existing_variant_quantity_{{ variant.id }}" value="{{ variant.quantity }}">
                                                    </div>
                                                </div>
                                            </div>
                                            {% if variant.image %}
                                            <div class="mb-3">
                                                <label class="form-label">Current Image</label>
                                                <div><img src="{{ variant.image.url }}" style="max-width: 100px; height: auto;"></div>
                                            </div>
                                            {% endif %}
                                            <div class="mb-3">
                                                <label class="form-label">Update Image</label>
                                                <input type="file" class="form-control" name="existing_variant_image_{{ variant.id }}" accept="image/*">
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            
                            <!-- New variants container -->
                            <div id="variants-container">
                                {% if not product.variants.all %}
                                <div class="text-muted">No variants added. Click "Add Variant" to create product options like size, color, etc.</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="/products/{{ product.id }}/" class="btn btn-secondary">Cancel</a>
                            <button type="submit" class="btn btn-primary">Update Product</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let variantCount = 0;

function addVariant() {
    const container = document.getElementById('variants-container');
    
    // Clear the "no variants" message
    if (container.innerHTML.includes('No variants added')) {
        container.innerHTML = '';
    }
    
    const variantDiv = document.createElement('div');
    variantDiv.className = 'card mb-3';
    variantDiv.innerHTML = `
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6>New Variant ${variantCount + 1}</h6>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeVariant(this)">Remove</button>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Variant Name</label>
                        <input type="text" class="form-control" name="variant_name_${variantCount}" placeholder="e.g., Red - Large">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">SKU (Optional)</label>
                        <input type="text" class="form-control" name="variant_sku_${variantCount}" placeholder="e.g., RED-LG-001">
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Price Override (Optional)</label>
                        <input type="number" step="0.01" class="form-control" name="variant_price_${variantCount}" placeholder="Leave empty to use product price">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Quantity</label>
                        <input type="number" class="form-control" name="variant_quantity_${variantCount}" value="0" min="0">
                    </div>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">Variant Image (Optional)</label>
                <input type="file" class="form-control" name="variant_image_${variantCount}" accept="image/*">
            </div>
        </div>
    `;
    
    container.appendChild(variantDiv);
    variantCount++;
}

function removeVariant(button) {
    button.closest('.card').remove();
}

function deleteVariant(variantId) {
    if (confirm('Are you sure you want to delete this variant?')) {
        // Add hidden input to mark for deletion
        const form = document.querySelector('form');
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'delete_variant_' + variantId;
        input.value = '1';
        form.appendChild(input);
        
        // Hide the variant card
        document.getElementById('existing-variant-' + variantId).style.display = 'none';
    }
}
</script>

{% endblock %}