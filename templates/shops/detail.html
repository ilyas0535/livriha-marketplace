{% extends 'base.html' %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="d-flex align-items-center mb-4">
            {% if shop.logo %}
                <img src="{{ shop.logo.url }}" alt="{{ shop.name }}" class="me-3" style="width: 80px; height: 80px; object-fit: cover; border-radius: 50%;">
            {% endif %}
            <div>
                <h1>{{ shop.name }}</h1>
                <p class="text-muted">{{ shop.description }}</p>
                <div class="text-warning mb-2">
                    {% for i in "12345" %}
                        <i class="{% if forloop.counter <= shop.sales_rating %}fas{% else %}far{% endif %} fa-star"></i>
                    {% endfor %}
                    <small class="text-muted">({{ shop.sales_count }} sold)</small>
                </div>
            </div>
        </div>
    </div>
</div>

<h3>Products</h3>
<div class="row">
    {% for product in products %}
    <div class="col-md-4 mb-4">
        <div class="card">
            {% with all_images=product.get_all_images %}
            {% if all_images %}
                <div id="shopCarousel{{ product.id }}" class="carousel slide" data-bs-ride="carousel">
                    <div class="carousel-inner">
                        {% for image in all_images %}
                        <div class="carousel-item {% if forloop.first %}active{% endif %}">
                            <img src="{{ image.url }}" class="d-block w-100" style="height: 250px; object-fit: contain; cursor: pointer; background: #f8f9fa;" alt="{{ image.alt }}">
                        </div>
                        {% endfor %}
                    </div>
                    {% if all_images|length > 1 %}
                    <button class="carousel-control-prev" type="button" data-bs-target="#shopCarousel{{ product.id }}" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon"></span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#shopCarousel{{ product.id }}" data-bs-slide="next">
                        <span class="carousel-control-next-icon"></span>
                    </button>
                    <!-- Image count indicator -->
                    <div class="position-absolute top-0 end-0 m-2">
                        <span class="badge bg-dark bg-opacity-75" style="font-size: 0.6rem;">{{ all_images|length }} photos</span>
                    </div>
                    {% endif %}
                </div>
            {% endif %}
            {% endwith %}
            <div class="card-body">
                <h5 class="card-title">
                    <a href="/products/{{ product.id }}/" class="text-decoration-none text-dark">{{ product.name }}</a>
                    {% if product.variants.count > 0 %}
                        <span class="badge bg-secondary ms-2" style="font-size: 0.7rem;">{{ product.variants.count }} variants</span>
                    {% endif %}
                </h5>
                <p class="card-text">{{ product.description|truncatewords:15 }}</p>
                <div class="text-warning mb-2">
                    {% for i in "12345" %}
                        <i class="{% if forloop.counter <= product.sales_rating %}fas{% else %}far{% endif %} fa-star" style="font-size: 14px;"></i>
                    {% endfor %}
                    <small class="text-muted">({{ product.sales_count }} sold)</small>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        {% if product.is_on_sale %}
                            <span class="text-muted text-decoration-line-through">${{ product.old_price }}</span>
                            <span class="text-danger fw-bold">${{ product.price }}</span>
                        {% else %}
                            <span class="fw-bold">${{ product.price }}</span>
                        {% endif %}
                    </div>
                </div>
                <div class="mt-2">
                    {% if user.is_authenticated and user == shop.owner %}
                        <a href="{% url 'edit_product' product.id %}" class="btn btn-warning btn-sm">Edit Product</a>
                    {% elif product.is_out_of_stock %}
                        <span class="badge bg-danger">Out of Stock</span>
                    {% else %}
                        <div class="d-flex gap-1 mb-2">
                            <a href="{% url 'add_to_cart' product.id %}" class="btn btn-primary btn-sm">Add to Cart</a>
                            <a href="{% url 'buy_now' product.id %}" class="btn btn-success btn-sm">Buy Now</a>
                        </div>
                    {% endif %}
                    {% if user.is_authenticated and user != shop.owner %}
                        <a href="{% url 'add_to_wishlist' product.id %}" class="btn btn-outline-secondary btn-sm mt-1">
                            <i class="far fa-heart"></i> Wishlist
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="col-12">
        <p>No products available in this shop yet.</p>
    </div>
    {% endfor %}
</div>
{% endblock %}